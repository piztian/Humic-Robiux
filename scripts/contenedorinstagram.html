<!-- Contenedor -->
<div id="ig-reels-grid" class="ig-reel-grid"></div>

<style>
  .ig-reel-grid{
    display:grid; grid-template-columns:1fr; gap:28px;
    max-width:1300px; margin:0 auto; padding:16px;
  }
  @media (min-width:768px){ .ig-reel-grid{ grid-template-columns:1fr 1fr; } }
  @media (min-width:1200px){ .ig-reel-grid{ grid-template-columns:1fr 1fr 1fr; } }

  .ig-reel-wrap{ max-width:460px; margin:0 auto; }
  @media (min-width:992px){ .ig-reel-wrap{ max-width:540px; } }

  .ig-box{
    position:relative; width:100%;
    background:#000; border-radius:12px; overflow:hidden;
  }
  /* Ratios por tipo */
  .ratio-9-16{ aspect-ratio: 9/16; }   /* Reels */
  .ratio-1-1 { aspect-ratio: 1/1; }    /* Post cuadrado */
  .ratio-4-5 { aspect-ratio: 4/5; }    /* Post vertical común */
  .ratio-16-9{ aspect-ratio: 16/9; }   /* IGTV/horizontal (fallback) */

  .ig-box iframe{ position:absolute; inset:0; width:100%; height:100%; border:0; }
  .ig-reel-title{
    margin:10px 0 0; font:600 15px/1.35 system-ui,-apple-system,Segoe UI,Arial,sans-serif;
    color:#1f2937; text-align:center;
  }
</style>

<script>
(function(){
  const SHEET_ID   = "1OMX3GpmgRDtO__q_t4HsTlnek48rLobLvsc94yiQyF4";
  const SHEET_NAME = "EmbedLinks";
  const SHEET_URL  = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}`;
  const mount = document.getElementById("ig-reels-grid");

  function toEmbedUrl(url){
    try{
      const u = new URL(url);
      if(/instagram\.com$/.test(u.hostname)){
        let path = u.pathname.replace(/\/$/,'');
        return `https://www.instagram.com${path}/embed`;
      }
      return url;
    }catch(e){ return url; }
  }

  // Detecta tipo y devuelve clase de ratio
  function ratioClass(url){
    try{
      const u = new URL(url);
      const p = u.pathname.toLowerCase();
      if(p.includes('/reel/')) return 'ratio-9-16';
      if(p.includes('/tv/'))   return 'ratio-16-9';   // IGTV suele ser horizontal
      if(p.includes('/p/'))    return 'ratio-4-5';    // post vertical típico
      return 'ratio-9-16'; // por defecto lo tratamos como reel
    }catch(e){ return 'ratio-9-16'; }
  }

  function isVisible(val){
    if(val == null) return true;
    const t = String(val).trim().toLowerCase();
    return ['si','sí','yes','1','true','y','s'].includes(t);
  }

  function parseGviz(text){
    const raw = text.substring(text.indexOf('{'), text.lastIndexOf('}')+1);
    const data = JSON.parse(raw);
    const rows = data.table?.rows || [];
    return rows.map(r => ({
      titulo:  r.c[0]?.v ?? '',
      url:     r.c[1]?.v ?? '',
      visible: isVisible(r.c[2]?.v ?? 'Si')
    }));
  }

  async function init(){
    try{
      const res = await fetch(SHEET_URL, {cache:'no-cache'});
      const text = await res.text();
      const items = parseGviz(text).filter(i => i.visible && i.url);

      if(!items.length){
        mount.innerHTML = "<p style='text-align:center;color:#6b7280'>No hay videos por mostrar.</p>";
        return;
      }

      const frag = document.createDocumentFragment();
      items.forEach(it => {
        const wrap = document.createElement('div');
        wrap.className = 'ig-reel-wrap';
        const embed = toEmbedUrl(it.url);
        const ratio = ratioClass(it.url);
        wrap.innerHTML = `
          <div class="ig-box ${ratio}">
            <iframe src="${embed}" allowfullscreen scrolling="no" loading="lazy"></iframe>
          </div>
          ${it.titulo ? `<div class="ig-reel-title">${it.titulo}</div>` : ''}
        `;
        frag.appendChild(wrap);
      });
      mount.replaceChildren(frag);
    }catch(err){
      console.error(err);
      mount.innerHTML = "<p style='text-align:center;color:#ef4444'>No se pudo cargar el listado desde Google Sheets.</p>";
    }
  }
  init();
})();
</script>
