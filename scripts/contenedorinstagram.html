<!-- Contenedor donde se pintará el grid -->
<div id="ig-reels-grid" class="ig-reel-grid"></div>

<style>
  .ig-reel-grid{
    display:grid; grid-template-columns:1fr; gap:24px;
    max-width:1200px; margin:0 auto; padding:16px;
  }
  @media (min-width:768px){ .ig-reel-grid{ grid-template-columns:1fr 1fr; } }
  @media (min-width:1200px){ .ig-reel-grid{ grid-template-columns:1fr 1fr 1fr; } }

  .ig-reel-wrap{ max-width:420px; margin:0 auto; }
  @media (min-width:992px){ .ig-reel-wrap{ max-width:480px; } }

  .ig-reel-ratio{
    position:relative; width:100%; aspect-ratio:9/16;
    background:#000; border-radius:12px; overflow:hidden;
  }
  .ig-reel-ratio iframe{
    position:absolute; inset:0; width:100%; height:100%; border:0;
  }
  .ig-reel-title{
    margin:8px 0 0; font:600 14px/1.3 system-ui, -apple-system, Segoe UI, Arial, sans-serif;
    color:#1f2937; text-align:center;
  }
</style>

<script>
(function(){
  // Tu Sheet: ID + nombre de pestaña
  const SHEET_ID   = "1OMX3GpmgRDtO__q_t4HsTlnek48rLobLvsc94yiQyF4";
  const SHEET_NAME = "EmbedLinks";

  // Endpoint gviz (JSON)
  const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}`;

  const mount = document.getElementById("ig-reels-grid");

  // Convierte URL normal de reel a /embed (acepta /reel/ o /reels/)
  function toEmbedUrl(url){
    try{
      const u = new URL(url);
      if(/instagram\.com$/.test(u.hostname)){
        const path = u.pathname.replace(/\/$/,"");
        if(!path.endsWith("/embed")){
          return `https://www.instagram.com${path}/embed`;
        }
      }
      return url;
    }catch(e){
      return url;
    }
  }

  // Normaliza "Si/No", "Sí/No", "Yes/No", "1/0", "true/false"
  function isVisible(val){
    if(val == null) return true;
    const t = String(val).trim().toLowerCase();
    return ["si","sí","yes","1","true","y","s"].includes(t);
  }

  // Parseo del JSON (formato gviz)
  function parseGviz(jsonText){
    const start = jsonText.indexOf("{");
    const end   = jsonText.lastIndexOf("}");
    const raw   = jsonText.substring(start, end + 1);
    const data  = JSON.parse(raw);
    const rows  = (data.table && data.table.rows) ? data.table.rows : [];
    // Esperado: 0=Titulo, 1=URL, 2=Visible
    return rows.map(r => ({
      titulo:  r.c[0]?.v ?? "",
      url:     r.c[1]?.v ?? "",
      visible: isVisible(r.c[2]?.v ?? "Si")
    }));
  }

  async function init(){
    try{
      const res = await fetch(SHEET_URL, { cache: "no-cache" });
      const text = await res.text();
      const items = parseGviz(text).filter(i => i.visible && i.url);

      if(!items.length){
        mount.innerHTML = "<p style='text-align:center;color:#6b7280'>No hay reels por mostrar.</p>";
        return;
      }

      const frag = document.createDocumentFragment();
      items.forEach(item => {
        const wrap = document.createElement("div");
        wrap.className = "ig-reel-wrap";
        wrap.innerHTML = `
          <div class="ig-reel-ratio">
            <iframe src="${toEmbedUrl(item.url)}" allowfullscreen scrolling="no" loading="lazy"></iframe>
          </div>
          ${item.titulo ? `<div class="ig-reel-title">${item.titulo}</div>` : ""}
        `;
        frag.appendChild(wrap);
      });
      mount.appendChild(frag);
    }catch(err){
      console.error(err);
      mount.innerHTML = "<p style='text-align:center;color:#ef4444'>No se pudo cargar el listado desde Google Sheets.</p>";
    }
  }
  init();
})();
</script>
